# MERN-website-api

### A website implemented using the MERN stack.

### Tools in use

- MongoDB (Mongoose)
- Express
- React
- Node.js

Additional dependencies

- Passport - for authentication

# Setup (production)

## GCP (Google Cloud Platform)

Info: Used to be able to login using Google.

### In APIs & Services:

- Enable the People API
- Create credentials (OAuth client ID) for an 'Web application' with redirect URI pointing to `/auth/google/redirect` route of server domain.
  - Development: the redirect URI should be set to
    `http://localhost:<PORT>/auth/google/redirect`
  - Production: To be written

### In App Engine:

Clone this repository to the cloud shell:

    git clone <repository>

## Environment variables setup

There are environment variables that must be set. They can be put in a file called `env_variables.yaml` (in root directory) in the format:

    env_variables:
      ENVIRONMENT_VARIABLE1: VALUE1
      ENVIRONMENT_VARIABLE2: VALUE2
      ...

### Environment variables:

- **CLIENT_SOCKET** - the address and port to UI, in development e.g. http://localhost:3000

- **SESSION_SECRET** - a randomized string used in hashing the server user sessions for security. Should just not be any easily guessable default string

- **COOKIE_MAX_AGE_MS** - After this time of user inactivity (in milliseconds), the user is logged out (session expired)

- **MONGO_URI** - MongoDB connection URI.

- **NODE_ENV** - If server is running in an `development` or `production` environment. In App Engine it is automatically set to `production`.

- **GOOGLE_OAUTH20_CLIENT_ID** - OAuth 2.0 client ID of your GCP (Google Cloud Platform) project with People API enabled. (In GCP -> Your project -> APIs & Services -> Credentials)

* **GOOGLE_OAUTH20_CLIENT_SECRET** - OAuth 2.0 client secret of your GCP project

* **PORT** - the port the server should listen to, e.g. 5000. In App Engine it is automatically set.

# Setup (development)

Follow the instructions for the section `Setup (production)`. Some additional steps need to be taken to simulate the configuration that Google App Engine have.

## TLS (optional)

TLS is recommended to test in development, to make sure that the app is able to work correctly. It should communicate securely, e.g. there should be no cookies or session data being sent unsecurely over HTTP.

### Instructions compatible with Ubuntu 18.04 LTS

Install [Nginx](https://www.nginx.com/resources/wiki/start/topics/tutorials/install/). From the terminal there are some options already known by Ubuntu (warning: don't install the light version):

    sudo apt install nginx-core
    sudo apt install nginx-extras
    sudo apt install nginx-full

#### Generate certificate

A self-signed certificate for development (localhost) can be generated by using:

    openssl req -x509 -out localhost.crt -keyout localhost.key \
      -newkey rsa:2048 -nodes -sha256 \
      -subj '/CN=localhost' -extensions EXT -config <( \
      printf "[dn]\nCN=localhost\n[req]\ndistinguished_name = dn\n[EXT]\nsubjectAltName=DNS:localhost\nkeyUsage=digitalSignature\nextendedKeyUsage=serverAuth")

The certificates are recommended to be put in the directory `/etc/nginx/tls/`

    sudo mkdir /etc/nginx/tls
    sudo mv localhost.crt /etc/nginx/tls/localhost.crt
    sudo mv localhost.key /etc/nginx/tls/localhost.key

#### Nginx configuration

Replace the contents of `/etc/nginx/sites-available/default` with the following content:

    server {
        listen 5001 ssl;
        server_name localhost;

        ssl_certificate /etc/nginx/tls/localhost.crt;
        ssl_certificate_key /etc/nginx/tls/localhost.key;

        location / {
            proxy_pass http://localhost:5000;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
        }
    }

Test the new configuration and making sure there are no errors by using:

    sudo nginx -t

Reload Nginx with the new configuration by using:

    sudo nginx -s reload

The server can now locally be reached using HTTPS on port 5001, where as HTTP can be reached on port 5000.

# Running the server

- In development:

      yarn run dev

- In production App Engine cloud shell:

      cd <repository>
      gcloud app create
      gcloud app deploy
